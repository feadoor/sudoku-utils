use crate::bitmask::Bitmask;
use crate::pipeline::RegionMaskedSudoku;

/// Solver capable of performing basic logic:
/// - Naked and Hidden Singles
/// - Pointing and Claiming
/// - Naked and Hidden Subsets
pub struct BasicSolver {
    candidate_positions: [Bitmask<u128>; 9],
    candidate_missing_regions: [Bitmask<u32>; 9],
    region_missing_candidates: [Bitmask<u16>; 27],
    unplaced: Bitmask<u128>,
}

impl BasicSolver {

    /// Initialise a solver with the clues from the given Sudoku
    pub fn for_region_masked_sudoku(sudoku: &RegionMaskedSudoku) -> Self {
        let mut result = Self {
            candidate_positions: [ALL_CELLS; 9],
            candidate_missing_regions: [ALL_REGIONS; 9],
            region_missing_candidates: [ALL_VALUES; 27],
            unplaced: ALL_CELLS,
        };
        for (cell, &val) in sudoku.sudoku().digits().enumerate() {
            if val != 0 {
                result.place_hidden_single(Bitmask::<u128>::singleton(cell), val as usize - 1);
            }
        }
        result
    }

    /// Eliminate all of the given candidates from consideration
    pub fn eliminate_candidates(&mut self, elims: &[((usize, usize), u8)]) {
        for &((row, col), val) in elims {
            self.candidate_positions[val as usize - 1].unset(9 * row + col)
        }
    }

    /// Carry out all basic deductions of the simplest kind for
    /// which any deductions exist
    pub fn step_basics(&mut self) -> Option<bool> {
        if self.do_naked_singles()? { return Some(true); }
        if self.do_hidden_singles()? { return Some(true); }
        Some(self.do_intersections() || self.do_subsets())
    }

    /// Carry out all basic deductions until no more remain
    pub fn solve_basics(&mut self) {
        while let Some(true) = self.step_basics() {}
    }

    /// Check if the puzzle is solved
    pub fn is_solved(&self) -> bool {
        self.unplaced.is_empty()
    }

    /// Count the number of solved cells
    pub fn empty_cells(&self) -> usize {
        self.unplaced.count_ones() as usize
    }

    /// Place a digit found via a Naked Single
    fn place_naked_single(&mut self, cell: usize, val: usize) {
        self.unplaced.unset(cell);
        self.candidate_positions[val] &= !PEERS[cell];
        self.candidate_missing_regions[val] &= !CELL_REGIONS[cell];
        for region in CELL_REGIONS[cell].as_bit_iter() {
            self.region_missing_candidates[region].unset(val);
        }
    }

    /// Place a digit found via a Hidden Single
    fn place_hidden_single(&mut self, cell_mask: Bitmask<u128>, val: usize) {
        for (other_val, positions) in self.candidate_positions.iter_mut().enumerate() {
            if other_val != val {
                *positions &= !cell_mask;
            }
        }
        self.place_naked_single(cell_mask.as_bit_iter().next().unwrap(), val);
    }

    /// Find and apply all Naked Singles
    fn do_naked_singles(&mut self) -> Option<bool> {
        let (mut at_least_once, mut more_than_once) = (Bitmask::<u128>::empty(), Bitmask::<u128>::empty());
        for positions in self.candidate_positions {
            more_than_once |= at_least_once & positions;
            at_least_once |= positions;
        }
        if at_least_once != ALL_CELLS { return None; }

        let naked_singles = at_least_once & !more_than_once & self.unplaced;
        for cell in naked_singles.as_bit_iter() {
            for val in 0 .. 9 {
                if self.candidate_positions[val].contains(cell) {
                    self.place_naked_single(cell, val);
                    break;
                }
            }
        }
        Some(naked_singles.is_not_empty())
    }

    /// Find and apply all Hidden Singles
    fn do_hidden_singles(&mut self) -> Option<bool> {
        let mut made_progress = false;
        for val in 0 .. 9 {
            for region in self.candidate_missing_regions[val].as_bit_iter() {
                let positions = REGIONS[region] & self.candidate_positions[val];
                match positions.count_ones() {
                    0 => return None,
                    1 => {
                        self.place_hidden_single(positions, val);
                        made_progress = true;
                    },
                    _ => {},
                }
            }
        }
        Some(made_progress)
    }

    /// Find and apply all Pointing and Claiming steps
    fn do_intersections(&mut self) -> bool {
        let mut made_progress = false;
        for (val, positions) in self.candidate_positions.iter_mut().enumerate() {
            for (triad, other_line, other_box) in TRIADS {
                if (*positions & triad).is_not_empty() {
                    match ((*positions & other_line).is_empty(), (*positions & other_box).is_empty()) {
                        (false, false) | (true, true) => {},
                        (true, false) => { *positions &= !other_box; made_progress = true; },
                        (false, true) => { *positions &= !other_line; made_progress = true; },
                    }
                }
            }
        }
        made_progress
    }

    /// Find and apply all Naked and Hidden Subsets
    fn do_subsets(&mut self) -> bool {
        let mut made_progress = false;
        for region in 0 .. 27 {
            let missing_count = self.region_missing_candidates[region].count_ones();
            if missing_count < 4 { continue; }
            for values in self.region_missing_candidates[region].as_subset_iter() {
                let sz = values.count_ones();
                if sz < 2 || sz + 2 > missing_count { continue; }
                let positions = values.as_bit_iter().map(|val| self.candidate_positions[val]).reduce(|a, b| a | b).unwrap() & REGIONS[region];
                if positions.count_ones() == sz {
                    for other_val in (ALL_VALUES & !values).as_bit_iter() {
                        if (self.candidate_positions[other_val] & positions).is_not_empty() {
                            self.candidate_positions[other_val] &= !positions;
                            made_progress = true;
                        }
                    }
                }
            }
        }
        made_progress
    }
}

pub const ALL_VALUES: Bitmask<u16> = Bitmask::<u16>::from(0b111111111);
pub const ALL_CELLS: Bitmask<u128> = Bitmask::<u128>::from(0b111111111_111111111_111111111_111111111_111111111_111111111_111111111_111111111_111111111);
pub const ALL_REGIONS: Bitmask<u32> = Bitmask::<u32>::from(0b111111111_111111111_111111111);

pub const REGIONS: [Bitmask<u128>; 27] = [
    Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000_111111111),
    Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_111111111_000000000),
    Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_111111111_000000000_000000000),
    Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_111111111_000000000_000000000_000000000),
    Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_111111111_000000000_000000000_000000000_000000000),
    Bitmask::<u128>::from(0b000000000_000000000_000000000_111111111_000000000_000000000_000000000_000000000_000000000),
    Bitmask::<u128>::from(0b000000000_000000000_111111111_000000000_000000000_000000000_000000000_000000000_000000000),
    Bitmask::<u128>::from(0b000000000_111111111_000000000_000000000_000000000_000000000_000000000_000000000_000000000),
    Bitmask::<u128>::from(0b111111111_000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000),
    
    Bitmask::<u128>::from(0b000000001_000000001_000000001_000000001_000000001_000000001_000000001_000000001_000000001),
    Bitmask::<u128>::from(0b000000010_000000010_000000010_000000010_000000010_000000010_000000010_000000010_000000010),
    Bitmask::<u128>::from(0b000000100_000000100_000000100_000000100_000000100_000000100_000000100_000000100_000000100),
    Bitmask::<u128>::from(0b000001000_000001000_000001000_000001000_000001000_000001000_000001000_000001000_000001000),
    Bitmask::<u128>::from(0b000010000_000010000_000010000_000010000_000010000_000010000_000010000_000010000_000010000),
    Bitmask::<u128>::from(0b000100000_000100000_000100000_000100000_000100000_000100000_000100000_000100000_000100000),
    Bitmask::<u128>::from(0b001000000_001000000_001000000_001000000_001000000_001000000_001000000_001000000_001000000),
    Bitmask::<u128>::from(0b010000000_010000000_010000000_010000000_010000000_010000000_010000000_010000000_010000000),
    Bitmask::<u128>::from(0b100000000_100000000_100000000_100000000_100000000_100000000_100000000_100000000_100000000),
    
    Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000111_000000111_000000111),
    Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000111000_000111000_000111000),
    Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_111000000_111000000_111000000),
    Bitmask::<u128>::from(0b000000000_000000000_000000000_000000111_000000111_000000111_000000000_000000000_000000000),
    Bitmask::<u128>::from(0b000000000_000000000_000000000_000111000_000111000_000111000_000000000_000000000_000000000),
    Bitmask::<u128>::from(0b000000000_000000000_000000000_111000000_111000000_111000000_000000000_000000000_000000000),
    Bitmask::<u128>::from(0b000000111_000000111_000000111_000000000_000000000_000000000_000000000_000000000_000000000),
    Bitmask::<u128>::from(0b000111000_000111000_000111000_000000000_000000000_000000000_000000000_000000000_000000000),
    Bitmask::<u128>::from(0b111000000_111000000_111000000_000000000_000000000_000000000_000000000_000000000_000000000),
];

pub const CELL_REGIONS: [Bitmask::<u32>; 81] = [
    Bitmask::<u32>::from(0b000000001_000000001_000000001),
    Bitmask::<u32>::from(0b000000001_000000010_000000001),
    Bitmask::<u32>::from(0b000000001_000000100_000000001),
    Bitmask::<u32>::from(0b000000010_000001000_000000001),
    Bitmask::<u32>::from(0b000000010_000010000_000000001),
    Bitmask::<u32>::from(0b000000010_000100000_000000001),
    Bitmask::<u32>::from(0b000000100_001000000_000000001),
    Bitmask::<u32>::from(0b000000100_010000000_000000001),
    Bitmask::<u32>::from(0b000000100_100000000_000000001),
    Bitmask::<u32>::from(0b000000001_000000001_000000010),
    Bitmask::<u32>::from(0b000000001_000000010_000000010),
    Bitmask::<u32>::from(0b000000001_000000100_000000010),
    Bitmask::<u32>::from(0b000000010_000001000_000000010),
    Bitmask::<u32>::from(0b000000010_000010000_000000010),
    Bitmask::<u32>::from(0b000000010_000100000_000000010),
    Bitmask::<u32>::from(0b000000100_001000000_000000010),
    Bitmask::<u32>::from(0b000000100_010000000_000000010),
    Bitmask::<u32>::from(0b000000100_100000000_000000010),
    Bitmask::<u32>::from(0b000000001_000000001_000000100),
    Bitmask::<u32>::from(0b000000001_000000010_000000100),
    Bitmask::<u32>::from(0b000000001_000000100_000000100),
    Bitmask::<u32>::from(0b000000010_000001000_000000100),
    Bitmask::<u32>::from(0b000000010_000010000_000000100),
    Bitmask::<u32>::from(0b000000010_000100000_000000100),
    Bitmask::<u32>::from(0b000000100_001000000_000000100),
    Bitmask::<u32>::from(0b000000100_010000000_000000100),
    Bitmask::<u32>::from(0b000000100_100000000_000000100),
    Bitmask::<u32>::from(0b000001000_000000001_000001000),
    Bitmask::<u32>::from(0b000001000_000000010_000001000),
    Bitmask::<u32>::from(0b000001000_000000100_000001000),
    Bitmask::<u32>::from(0b000010000_000001000_000001000),
    Bitmask::<u32>::from(0b000010000_000010000_000001000),
    Bitmask::<u32>::from(0b000010000_000100000_000001000),
    Bitmask::<u32>::from(0b000100000_001000000_000001000),
    Bitmask::<u32>::from(0b000100000_010000000_000001000),
    Bitmask::<u32>::from(0b000100000_100000000_000001000),
    Bitmask::<u32>::from(0b000001000_000000001_000010000),
    Bitmask::<u32>::from(0b000001000_000000010_000010000),
    Bitmask::<u32>::from(0b000001000_000000100_000010000),
    Bitmask::<u32>::from(0b000010000_000001000_000010000),
    Bitmask::<u32>::from(0b000010000_000010000_000010000),
    Bitmask::<u32>::from(0b000010000_000100000_000010000),
    Bitmask::<u32>::from(0b000100000_001000000_000010000),
    Bitmask::<u32>::from(0b000100000_010000000_000010000),
    Bitmask::<u32>::from(0b000100000_100000000_000010000),
    Bitmask::<u32>::from(0b000001000_000000001_000100000),
    Bitmask::<u32>::from(0b000001000_000000010_000100000),
    Bitmask::<u32>::from(0b000001000_000000100_000100000),
    Bitmask::<u32>::from(0b000010000_000001000_000100000),
    Bitmask::<u32>::from(0b000010000_000010000_000100000),
    Bitmask::<u32>::from(0b000010000_000100000_000100000),
    Bitmask::<u32>::from(0b000100000_001000000_000100000),
    Bitmask::<u32>::from(0b000100000_010000000_000100000),
    Bitmask::<u32>::from(0b000100000_100000000_000100000),
    Bitmask::<u32>::from(0b001000000_000000001_001000000),
    Bitmask::<u32>::from(0b001000000_000000010_001000000),
    Bitmask::<u32>::from(0b001000000_000000100_001000000),
    Bitmask::<u32>::from(0b010000000_000001000_001000000),
    Bitmask::<u32>::from(0b010000000_000010000_001000000),
    Bitmask::<u32>::from(0b010000000_000100000_001000000),
    Bitmask::<u32>::from(0b100000000_001000000_001000000),
    Bitmask::<u32>::from(0b100000000_010000000_001000000),
    Bitmask::<u32>::from(0b100000000_100000000_001000000),
    Bitmask::<u32>::from(0b001000000_000000001_010000000),
    Bitmask::<u32>::from(0b001000000_000000010_010000000),
    Bitmask::<u32>::from(0b001000000_000000100_010000000),
    Bitmask::<u32>::from(0b010000000_000001000_010000000),
    Bitmask::<u32>::from(0b010000000_000010000_010000000),
    Bitmask::<u32>::from(0b010000000_000100000_010000000),
    Bitmask::<u32>::from(0b100000000_001000000_010000000),
    Bitmask::<u32>::from(0b100000000_010000000_010000000),
    Bitmask::<u32>::from(0b100000000_100000000_010000000),
    Bitmask::<u32>::from(0b001000000_000000001_100000000),
    Bitmask::<u32>::from(0b001000000_000000010_100000000),
    Bitmask::<u32>::from(0b001000000_000000100_100000000),
    Bitmask::<u32>::from(0b010000000_000001000_100000000),
    Bitmask::<u32>::from(0b010000000_000010000_100000000),
    Bitmask::<u32>::from(0b010000000_000100000_100000000),
    Bitmask::<u32>::from(0b100000000_001000000_100000000),
    Bitmask::<u32>::from(0b100000000_010000000_100000000),
    Bitmask::<u32>::from(0b100000000_100000000_100000000),
];

pub const TRIADS: [(Bitmask::<u128>, Bitmask::<u128>, Bitmask::<u128>); 54] = [
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000111), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000_111111000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000111_000000111_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000_000111000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000_111000111), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000111000_000111000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000_111000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000_000111111), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_111000000_111000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000111_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_111111000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000111_000000000_000000111)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_000111000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_111000111_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000111000_000000000_000111000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_111000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_000111111_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_111000000_000000000_111000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000111_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_111111000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000111_000000111)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000111000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_111000111_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_000111000_000111000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_111000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000111111_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000000_111000000_111000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000111_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_111111000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000111_000000111_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000111000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_111000111_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000111000_000111000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_111000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000111111_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_111000000_111000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000111_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_111111000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000111_000000000_000000111_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000111000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_111000111_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000111000_000000000_000111000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_111000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000111111_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_111000000_000000000_111000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000111_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_111111000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000111_000000111_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000111000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_111000111_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000111000_000111000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_111000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000111111_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_111000000_111000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000111_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_111111000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000111_000000111_000000000_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000111000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_111000111_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000111000_000111000_000000000_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_111000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000111111_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b111000000_111000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000111_000000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_111111000_000000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000111_000000000_000000111_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000111000_000000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_111000111_000000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000111000_000000000_000111000_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_111000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000111111_000000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b111000000_000000000_111000000_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000111_000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b111111000_000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000111_000000111_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000111000_000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b111000111_000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000111000_000111000_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b111000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000111111_000000000_000000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_111000000_111000000_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000001_000000001_000000001), Bitmask::<u128>::from(0b000000001_000000001_000000001_000000001_000000001_000000001_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000110_000000110_000000110)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000001_000000001_000000001_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000001_000000001_000000001_000000000_000000000_000000000_000000001_000000001_000000001), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000110_000000110_000000110_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000001_000000001_000000001_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000001_000000001_000000001_000000001_000000001_000000001), Bitmask::<u128>::from(0b000000110_000000110_000000110_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000010_000000010_000000010), Bitmask::<u128>::from(0b000000010_000000010_000000010_000000010_000000010_000000010_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000101_000000101_000000101)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000010_000000010_000000010_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000010_000000010_000000010_000000000_000000000_000000000_000000010_000000010_000000010), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000101_000000101_000000101_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000010_000000010_000000010_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000010_000000010_000000010_000000010_000000010_000000010), Bitmask::<u128>::from(0b000000101_000000101_000000101_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000100_000000100_000000100), Bitmask::<u128>::from(0b000000100_000000100_000000100_000000100_000000100_000000100_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000000011_000000011_000000011)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000100_000000100_000000100_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000100_000000100_000000100_000000000_000000000_000000000_000000100_000000100_000000100), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000011_000000011_000000011_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000100_000000100_000000100_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000100_000000100_000000100_000000100_000000100_000000100), Bitmask::<u128>::from(0b000000011_000000011_000000011_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000001000_000001000_000001000), Bitmask::<u128>::from(0b000001000_000001000_000001000_000001000_000001000_000001000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000110000_000110000_000110000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000001000_000001000_000001000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000001000_000001000_000001000_000000000_000000000_000000000_000001000_000001000_000001000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000110000_000110000_000110000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000001000_000001000_000001000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000001000_000001000_000001000_000001000_000001000_000001000), Bitmask::<u128>::from(0b000110000_000110000_000110000_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000010000_000010000_000010000), Bitmask::<u128>::from(0b000010000_000010000_000010000_000010000_000010000_000010000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000101000_000101000_000101000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000010000_000010000_000010000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000010000_000010000_000010000_000000000_000000000_000000000_000010000_000010000_000010000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000101000_000101000_000101000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000010000_000010000_000010000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000010000_000010000_000010000_000010000_000010000_000010000), Bitmask::<u128>::from(0b000101000_000101000_000101000_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000100000_000100000_000100000), Bitmask::<u128>::from(0b000100000_000100000_000100000_000100000_000100000_000100000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_000011000_000011000_000011000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000100000_000100000_000100000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000100000_000100000_000100000_000000000_000000000_000000000_000100000_000100000_000100000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000011000_000011000_000011000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000100000_000100000_000100000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000100000_000100000_000100000_000100000_000100000_000100000), Bitmask::<u128>::from(0b000011000_000011000_000011000_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_001000000_001000000_001000000), Bitmask::<u128>::from(0b001000000_001000000_001000000_001000000_001000000_001000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_110000000_110000000_110000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_001000000_001000000_001000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b001000000_001000000_001000000_000000000_000000000_000000000_001000000_001000000_001000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_110000000_110000000_110000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b001000000_001000000_001000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_001000000_001000000_001000000_001000000_001000000_001000000), Bitmask::<u128>::from(0b110000000_110000000_110000000_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_010000000_010000000_010000000), Bitmask::<u128>::from(0b010000000_010000000_010000000_010000000_010000000_010000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_101000000_101000000_101000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_010000000_010000000_010000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b010000000_010000000_010000000_000000000_000000000_000000000_010000000_010000000_010000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_101000000_101000000_101000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b010000000_010000000_010000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_010000000_010000000_010000000_010000000_010000000_010000000), Bitmask::<u128>::from(0b101000000_101000000_101000000_000000000_000000000_000000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_100000000_100000000_100000000), Bitmask::<u128>::from(0b100000000_100000000_100000000_100000000_100000000_100000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_000000000_000000000_000000000_011000000_011000000_011000000)),
    (Bitmask::<u128>::from(0b000000000_000000000_000000000_100000000_100000000_100000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b100000000_100000000_100000000_000000000_000000000_000000000_100000000_100000000_100000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_011000000_011000000_011000000_000000000_000000000_000000000)),
    (Bitmask::<u128>::from(0b100000000_100000000_100000000_000000000_000000000_000000000_000000000_000000000_000000000), Bitmask::<u128>::from(0b000000000_000000000_000000000_100000000_100000000_100000000_100000000_100000000_100000000), Bitmask::<u128>::from(0b011000000_011000000_011000000_000000000_000000000_000000000_000000000_000000000_000000000)),
];

pub const PEERS: [Bitmask::<u128>; 81] = [
    Bitmask::<u128>::from(0b000000001_000000001_000000001_000000001_000000001_000000001_000000111_000000111_111111110),
    Bitmask::<u128>::from(0b000000010_000000010_000000010_000000010_000000010_000000010_000000111_000000111_111111101),
    Bitmask::<u128>::from(0b000000100_000000100_000000100_000000100_000000100_000000100_000000111_000000111_111111011),
    Bitmask::<u128>::from(0b000001000_000001000_000001000_000001000_000001000_000001000_000111000_000111000_111110111),
    Bitmask::<u128>::from(0b000010000_000010000_000010000_000010000_000010000_000010000_000111000_000111000_111101111),
    Bitmask::<u128>::from(0b000100000_000100000_000100000_000100000_000100000_000100000_000111000_000111000_111011111),
    Bitmask::<u128>::from(0b001000000_001000000_001000000_001000000_001000000_001000000_111000000_111000000_110111111),
    Bitmask::<u128>::from(0b010000000_010000000_010000000_010000000_010000000_010000000_111000000_111000000_101111111),
    Bitmask::<u128>::from(0b100000000_100000000_100000000_100000000_100000000_100000000_111000000_111000000_011111111),
    Bitmask::<u128>::from(0b000000001_000000001_000000001_000000001_000000001_000000001_000000111_111111110_000000111),
    Bitmask::<u128>::from(0b000000010_000000010_000000010_000000010_000000010_000000010_000000111_111111101_000000111),
    Bitmask::<u128>::from(0b000000100_000000100_000000100_000000100_000000100_000000100_000000111_111111011_000000111),
    Bitmask::<u128>::from(0b000001000_000001000_000001000_000001000_000001000_000001000_000111000_111110111_000111000),
    Bitmask::<u128>::from(0b000010000_000010000_000010000_000010000_000010000_000010000_000111000_111101111_000111000),
    Bitmask::<u128>::from(0b000100000_000100000_000100000_000100000_000100000_000100000_000111000_111011111_000111000),
    Bitmask::<u128>::from(0b001000000_001000000_001000000_001000000_001000000_001000000_111000000_110111111_111000000),
    Bitmask::<u128>::from(0b010000000_010000000_010000000_010000000_010000000_010000000_111000000_101111111_111000000),
    Bitmask::<u128>::from(0b100000000_100000000_100000000_100000000_100000000_100000000_111000000_011111111_111000000),
    Bitmask::<u128>::from(0b000000001_000000001_000000001_000000001_000000001_000000001_111111110_000000111_000000111),
    Bitmask::<u128>::from(0b000000010_000000010_000000010_000000010_000000010_000000010_111111101_000000111_000000111),
    Bitmask::<u128>::from(0b000000100_000000100_000000100_000000100_000000100_000000100_111111011_000000111_000000111),
    Bitmask::<u128>::from(0b000001000_000001000_000001000_000001000_000001000_000001000_111110111_000111000_000111000),
    Bitmask::<u128>::from(0b000010000_000010000_000010000_000010000_000010000_000010000_111101111_000111000_000111000),
    Bitmask::<u128>::from(0b000100000_000100000_000100000_000100000_000100000_000100000_111011111_000111000_000111000),
    Bitmask::<u128>::from(0b001000000_001000000_001000000_001000000_001000000_001000000_110111111_111000000_111000000),
    Bitmask::<u128>::from(0b010000000_010000000_010000000_010000000_010000000_010000000_101111111_111000000_111000000),
    Bitmask::<u128>::from(0b100000000_100000000_100000000_100000000_100000000_100000000_011111111_111000000_111000000),
    Bitmask::<u128>::from(0b000000001_000000001_000000001_000000111_000000111_111111110_000000001_000000001_000000001),
    Bitmask::<u128>::from(0b000000010_000000010_000000010_000000111_000000111_111111101_000000010_000000010_000000010),
    Bitmask::<u128>::from(0b000000100_000000100_000000100_000000111_000000111_111111011_000000100_000000100_000000100),
    Bitmask::<u128>::from(0b000001000_000001000_000001000_000111000_000111000_111110111_000001000_000001000_000001000),
    Bitmask::<u128>::from(0b000010000_000010000_000010000_000111000_000111000_111101111_000010000_000010000_000010000),
    Bitmask::<u128>::from(0b000100000_000100000_000100000_000111000_000111000_111011111_000100000_000100000_000100000),
    Bitmask::<u128>::from(0b001000000_001000000_001000000_111000000_111000000_110111111_001000000_001000000_001000000),
    Bitmask::<u128>::from(0b010000000_010000000_010000000_111000000_111000000_101111111_010000000_010000000_010000000),
    Bitmask::<u128>::from(0b100000000_100000000_100000000_111000000_111000000_011111111_100000000_100000000_100000000),
    Bitmask::<u128>::from(0b000000001_000000001_000000001_000000111_111111110_000000111_000000001_000000001_000000001),
    Bitmask::<u128>::from(0b000000010_000000010_000000010_000000111_111111101_000000111_000000010_000000010_000000010),
    Bitmask::<u128>::from(0b000000100_000000100_000000100_000000111_111111011_000000111_000000100_000000100_000000100),
    Bitmask::<u128>::from(0b000001000_000001000_000001000_000111000_111110111_000111000_000001000_000001000_000001000),
    Bitmask::<u128>::from(0b000010000_000010000_000010000_000111000_111101111_000111000_000010000_000010000_000010000),
    Bitmask::<u128>::from(0b000100000_000100000_000100000_000111000_111011111_000111000_000100000_000100000_000100000),
    Bitmask::<u128>::from(0b001000000_001000000_001000000_111000000_110111111_111000000_001000000_001000000_001000000),
    Bitmask::<u128>::from(0b010000000_010000000_010000000_111000000_101111111_111000000_010000000_010000000_010000000),
    Bitmask::<u128>::from(0b100000000_100000000_100000000_111000000_011111111_111000000_100000000_100000000_100000000),
    Bitmask::<u128>::from(0b000000001_000000001_000000001_111111110_000000111_000000111_000000001_000000001_000000001),
    Bitmask::<u128>::from(0b000000010_000000010_000000010_111111101_000000111_000000111_000000010_000000010_000000010),
    Bitmask::<u128>::from(0b000000100_000000100_000000100_111111011_000000111_000000111_000000100_000000100_000000100),
    Bitmask::<u128>::from(0b000001000_000001000_000001000_111110111_000111000_000111000_000001000_000001000_000001000),
    Bitmask::<u128>::from(0b000010000_000010000_000010000_111101111_000111000_000111000_000010000_000010000_000010000),
    Bitmask::<u128>::from(0b000100000_000100000_000100000_111011111_000111000_000111000_000100000_000100000_000100000),
    Bitmask::<u128>::from(0b001000000_001000000_001000000_110111111_111000000_111000000_001000000_001000000_001000000),
    Bitmask::<u128>::from(0b010000000_010000000_010000000_101111111_111000000_111000000_010000000_010000000_010000000),
    Bitmask::<u128>::from(0b100000000_100000000_100000000_011111111_111000000_111000000_100000000_100000000_100000000),
    Bitmask::<u128>::from(0b000000111_000000111_111111110_000000001_000000001_000000001_000000001_000000001_000000001),
    Bitmask::<u128>::from(0b000000111_000000111_111111101_000000010_000000010_000000010_000000010_000000010_000000010),
    Bitmask::<u128>::from(0b000000111_000000111_111111011_000000100_000000100_000000100_000000100_000000100_000000100),
    Bitmask::<u128>::from(0b000111000_000111000_111110111_000001000_000001000_000001000_000001000_000001000_000001000),
    Bitmask::<u128>::from(0b000111000_000111000_111101111_000010000_000010000_000010000_000010000_000010000_000010000),
    Bitmask::<u128>::from(0b000111000_000111000_111011111_000100000_000100000_000100000_000100000_000100000_000100000),
    Bitmask::<u128>::from(0b111000000_111000000_110111111_001000000_001000000_001000000_001000000_001000000_001000000),
    Bitmask::<u128>::from(0b111000000_111000000_101111111_010000000_010000000_010000000_010000000_010000000_010000000),
    Bitmask::<u128>::from(0b111000000_111000000_011111111_100000000_100000000_100000000_100000000_100000000_100000000),
    Bitmask::<u128>::from(0b000000111_111111110_000000111_000000001_000000001_000000001_000000001_000000001_000000001),
    Bitmask::<u128>::from(0b000000111_111111101_000000111_000000010_000000010_000000010_000000010_000000010_000000010),
    Bitmask::<u128>::from(0b000000111_111111011_000000111_000000100_000000100_000000100_000000100_000000100_000000100),
    Bitmask::<u128>::from(0b000111000_111110111_000111000_000001000_000001000_000001000_000001000_000001000_000001000),
    Bitmask::<u128>::from(0b000111000_111101111_000111000_000010000_000010000_000010000_000010000_000010000_000010000),
    Bitmask::<u128>::from(0b000111000_111011111_000111000_000100000_000100000_000100000_000100000_000100000_000100000),
    Bitmask::<u128>::from(0b111000000_110111111_111000000_001000000_001000000_001000000_001000000_001000000_001000000),
    Bitmask::<u128>::from(0b111000000_101111111_111000000_010000000_010000000_010000000_010000000_010000000_010000000),
    Bitmask::<u128>::from(0b111000000_011111111_111000000_100000000_100000000_100000000_100000000_100000000_100000000),
    Bitmask::<u128>::from(0b111111110_000000111_000000111_000000001_000000001_000000001_000000001_000000001_000000001),
    Bitmask::<u128>::from(0b111111101_000000111_000000111_000000010_000000010_000000010_000000010_000000010_000000010),
    Bitmask::<u128>::from(0b111111011_000000111_000000111_000000100_000000100_000000100_000000100_000000100_000000100),
    Bitmask::<u128>::from(0b111110111_000111000_000111000_000001000_000001000_000001000_000001000_000001000_000001000),
    Bitmask::<u128>::from(0b111101111_000111000_000111000_000010000_000010000_000010000_000010000_000010000_000010000),
    Bitmask::<u128>::from(0b111011111_000111000_000111000_000100000_000100000_000100000_000100000_000100000_000100000),
    Bitmask::<u128>::from(0b110111111_111000000_111000000_001000000_001000000_001000000_001000000_001000000_001000000),
    Bitmask::<u128>::from(0b101111111_111000000_111000000_010000000_010000000_010000000_010000000_010000000_010000000),
    Bitmask::<u128>::from(0b011111111_111000000_111000000_100000000_100000000_100000000_100000000_100000000_100000000),
];
